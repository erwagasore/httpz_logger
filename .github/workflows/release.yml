name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version bump commit message
        id: check_bump
        run: |
          # Extract bump type from commit message
          # Format: "feat:" = minor, "fix:" = patch, "BREAKING:" = major, "release:" = as specified
          commit_msg="${{ github.event.head_commit.message }}"
          if [[ "$commit_msg" == *"BREAKING:"* ]] || [[ "$commit_msg" == *"breaking:"* ]]; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif [[ "$commit_msg" == *"feat:"* ]]; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          elif [[ "$commit_msg" == *"fix:"* ]] || [[ "$commit_msg" == *"docs:"* ]] || [[ "$commit_msg" == *"chore:"* ]]; then
            echo "bump=patch" >> $GITHUB_OUTPUT
          elif [[ "$commit_msg" == *"release: major"* ]]; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif [[ "$commit_msg" == *"release: minor"* ]]; then
            echo "bump=minor" >> $GITHUB_OUTPUT  
          elif [[ "$commit_msg" == *"release: patch"* ]]; then
            echo "bump=patch" >> $GITHUB_OUTPUT
          else
            echo "bump=none" >> $GITHUB_OUTPUT
          fi

      - name: Bump version and push tag
        id: tag
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: ${{ steps.check_bump.outputs.bump }}
          WITH_V: true
          RELEASE_BRANCHES: main
          VERBOSE: true

      - name: Update build.zig.zon
        if: steps.tag.outputs.new_tag != steps.tag.outputs.tag
        run: |
          version="${{ steps.tag.outputs.new_tag }}"
          sed -i "s/\.version = \"[^\"]*\"/.version = \"${version#v}\"/" build.zig.zon
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add build.zig.zon
          git commit -m "chore: bump version to $version" || true
          git push

      - name: Generate changelog
        id: changelog
        if: steps.tag.outputs.new_tag != steps.tag.outputs.tag
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configurationJson: |
            {
              "categories": [
                {
                  "title": "## üöÄ Features",
                  "labels": ["feature", "enhancement", "feat"]
                },
                {
                  "title": "## üêõ Bug Fixes",
                  "labels": ["fix", "bugfix", "bug"]
                },
                {
                  "title": "## üìö Documentation",
                  "labels": ["documentation", "docs"]
                },
                {
                  "title": "## üî® Refactoring",
                  "labels": ["refactor", "refactoring"]
                },
                {
                  "title": "## üß™ Testing",
                  "labels": ["test", "tests", "testing"]
                },
                {
                  "title": "## ‚ö° Performance",
                  "labels": ["performance", "optimization", "perf"]
                },
                {
                  "title": "## üîí Security",
                  "labels": ["security"]
                },
                {
                  "title": "## üîß Maintenance",
                  "labels": ["chore", "maintenance", "ci", "build"]
                }
              ],
              "pr_template": "- #{{TITLE}} by @#{{AUTHOR}} in ##{{NUMBER}}",
              "template": "#{{CHANGELOG}}\n\n**Full Changelog**: #{{RELEASE_DIFF}}",
              "empty_template": "- No changes",
              "max_pull_requests": 30,
              "max_back_track_time_days": 365
            }
          toTag: ${{ steps.tag.outputs.new_tag }}
          fromTag: ${{ steps.tag.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        if: steps.tag.outputs.new_tag != steps.tag.outputs.tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          name: Release ${{ steps.tag.outputs.new_tag }}
          body: |
            # Release ${{ steps.tag.outputs.new_tag }}

            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            Add to your `build.zig.zon`:
            ```zig
            .dependencies = .{
                .httpz_logger = .{
                    .url = "https://github.com/${{ github.repository }}/archive/${{ steps.tag.outputs.new_tag }}.tar.gz",
                },
            }
            ```

            Then run:
            ```bash
            zig fetch --save https://github.com/${{ github.repository }}/archive/${{ steps.tag.outputs.new_tag }}.tar.gz
            ```
          draft: false
          prerelease: false
