name: Release Please

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: simple
          package-name: httpz-logger

          # Version bumping rules
          bump-minor-pre-major: true # Before 1.0.0, bump minor for breaking changes
          bump-patch-for-minor-pre-major: true # Before 1.0.0, bump patch for features

          # Files to update version in
          extra-files: |
            build.zig.zon

          # Changelog configuration
          changelog-types: |
            [
              {"type": "feat", "section": "âœ¨ Features", "hidden": false},
              {"type": "fix", "section": "ğŸ› Bug Fixes", "hidden": false},
              {"type": "perf", "section": "âš¡ Performance Improvements", "hidden": false},
              {"type": "deps", "section": "ğŸ“¦ Dependencies", "hidden": false},
              {"type": "docs", "section": "ğŸ“š Documentation", "hidden": false},
              {"type": "test", "section": "ğŸ§ª Tests", "hidden": true},
              {"type": "refactor", "section": "â™»ï¸ Code Refactoring", "hidden": true},
              {"type": "style", "section": "ğŸ’„ Styling", "hidden": true},
              {"type": "ci", "section": "ğŸ”§ CI/CD", "hidden": true},
              {"type": "chore", "section": "ğŸ”§ Miscellaneous", "hidden": true},
              {"type": "revert", "section": "âª Reverts", "hidden": false}
            ]

      # Only run these steps if a release was created
      - uses: actions/checkout@v4
        if: ${{ steps.release.outputs.release_created }}

      - uses: mlugg/setup-zig@v2
        if: ${{ steps.release.outputs.release_created }}
        with:
          version: 0.15.2

      - name: Cache Zig dependencies
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            .zig-cache
          key: ${{ runner.os }}-zig-${{ hashFiles('build.zig.zon') }}
          restore-keys: |
            ${{ runner.os }}-zig-

      - name: Run tests before release
        if: ${{ steps.release.outputs.release_created }}
        run: zig build test

      - name: Build release artifacts
        if: ${{ steps.release.outputs.release_created }}
        run: zig build -Doptimize=ReleaseFast

      - name: Update release notes with installation instructions
        if: ${{ steps.release.outputs.release_created }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the current release body
          gh release view ${{ steps.release.outputs.tag_name }} --json body -q .body > current_notes.md

          # Append installation instructions
          cat >> current_notes.md << 'EOF'

          ## ğŸ“¦ Installation

          Add to your `build.zig.zon`:
          ```zig
          .dependencies = .{
              .httpz_logger = .{
                  .url = "https://github.com/${{ github.repository }}/archive/${{ steps.release.outputs.tag_name }}.tar.gz",
              },
          }
          ```

          Then run:
          ```bash
          zig fetch --save https://github.com/${{ github.repository }}/archive/${{ steps.release.outputs.tag_name }}.tar.gz
          ```

          ## ğŸ“– Usage

          ```zig
          const httpz = @import("httpz");
          const HttpLogger = @import("httpz_logger");

          var server = try httpz.Server().init(allocator, .{});
          try server.middleware(HttpLogger, .{
              .format = .json,
              .min_status = 400,  // Only log errors
          });
          ```
          EOF

          # Update the release
          gh release edit ${{ steps.release.outputs.tag_name }} --notes-file current_notes.md
